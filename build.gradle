plugins {
    id 'org.jetbrains.kotlin.jvm' version "2.2.20" apply false
    id "org.jetbrains.kotlin.plugin.allopen" version "2.2.20" apply false
    id 'org.jetbrains.kotlin.plugin.serialization' version "2.2.20" apply false
    id 'io.quarkus' apply false
    id "org.jlleitschuh.gradle.ktlint" version "12.1.2" apply false
}

allprojects {
    repositories {
        mavenCentral()
        mavenLocal()
    }

    group = 'chiro.erp'
    version = '1.0.0-SNAPSHOT'
}

subprojects {
    apply plugin: 'org.jetbrains.kotlin.jvm'
    apply plugin: 'org.jetbrains.kotlin.plugin.allopen'
    apply plugin: 'org.jetbrains.kotlin.plugin.serialization'
    apply plugin: 'io.quarkus'
    apply plugin: 'org.jlleitschuh.gradle.ktlint'

    java {
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    dependencies {
        implementation enforcedPlatform("${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}")
        implementation 'io.quarkus:quarkus-kotlin'
        implementation 'io.quarkus:quarkus-arc'

        // Common dependencies for all microservices
        implementation 'io.quarkus:quarkus-rest'
        implementation 'io.quarkus:quarkus-rest-jackson'
        implementation 'io.quarkus:quarkus-smallrye-health'

        // Kafka Messaging
        implementation 'io.quarkus:quarkus-messaging-kafka'

        testImplementation 'io.quarkus:quarkus-junit5'
        testImplementation 'io.rest-assured:rest-assured'
    }

    test {
        systemProperty "java.util.logging.manager", "org.jboss.logmanager.LogManager"
        jvmArgs "--add-opens", "java.base/java.lang=ALL-UNNAMED"
    }

    allOpen {
        annotation("jakarta.ws.rs.Path")
        annotation("jakarta.enterprise.context.ApplicationScoped")
        annotation("jakarta.persistence.Entity")
        annotation("io.quarkus.test.junit.QuarkusTest")
    }

    compileKotlin {
        kotlinOptions.jvmTarget = JavaVersion.VERSION_21
        kotlinOptions.javaParameters = true
    }

    compileTestKotlin {
        kotlinOptions.jvmTarget = JavaVersion.VERSION_21
    }

    // ktlint configuration
    ktlint {
        version = "1.0.1"
        debug = false
        verbose = false
        android = false
        outputToConsole = true
        outputColorName = "RED"
        ignoreFailures = true
        enableExperimentalRules = false
        // Disable problematic rules for now - using correct rule names for ktlint 1.0+
        disabledRules = [
            "standard:filename", // Allow empty files (placeholder files)
            "standard:no-wildcard-imports" // Allow wildcard imports temporarily
        ]

        filter {
            exclude("**/generated/**")
            exclude("**/build/**")
            exclude("**/Placeholder*.kt") // Exclude placeholder files
        }
    }
}

// Multi-module tasks
task buildAllServices {
    dependsOn subprojects.collect { it.tasks.named('build') }
    description = 'Build all microservices'
    group = 'build'
}

task cleanAllServices {
    dependsOn subprojects.collect { it.tasks.named('clean') }
    description = 'Clean all microservices'
    group = 'build'
}

// ktlint tasks for all services
task ktlintCheckAll {
    dependsOn subprojects.collect { it.tasks.named('ktlintCheck') }
    description = 'Run ktlint check on all microservices'
    group = 'verification'
}

task ktlintFormatAll {
    dependsOn subprojects.collect { it.tasks.named('ktlintFormat') }
    description = 'Run ktlint format on all microservices'
    group = 'formatting'
}
